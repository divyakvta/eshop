<%- include('../partials/user/userHeader') %>

<section class="pt-5 pb-5">
  <div class="container">
    <div class="row w-100">
      <div class="col-lg-12 col-md-12 col-12">
        <h4 class="display-5 mb-2 text-center">Your Cart</h4>
        <table id="shoppingCart" class="table table-condensed table-responsive">
          <thead>
            <tr>
              <th style="width:60%">Product</th>
              <th style="width:12%">Price</th>
              <th style="width:10%">Quantity</th>
              <th style="width:16%"></th>
            </tr>
          </thead>
          <tbody>
            <% if (products && products.items.length > 0) { %>
              <% let total = 0;
               products.items.forEach(item => { %>
                <tr>
                  <td data-th="Product">
                    <div class="row">
                      <div class="col-md-3 text-left">
                        <img src="/uploads/<%= item.product.images[0].url %>" alt="" class="img-fluid d-none d-md-block rounded mb-2 shadow " width="50px" >
                      </div>
                      <div class="col-md-9 text-left mt-sm-2">
                        <h4><%= item.product.title %></h4>
                        <p class="font-weight-light"><%= item.product.desc %> </p>
                      </div>
                    </div>
                  </td>
                  <td data-th="Price">Rs. <%= item.product.price %></td>
                  <td data-th="Quantity">
                  <div class="input-group" id="<%= item.product._id %>">
                    <button class="btn btn-outline-dark increase" type="button" id="inc" style="font-size: 12px;">+</button>
                    <input style="width: 20px; text-align: center; font-size: 12px;" type="text" data-product-id="<%= item.product._id %>"
                      class="form-control quantity-amount" value="<%= item.quantity %>" max="10"
                      aria-label="Example text with button addon" aria-describedby="button-addon1">
                    <button class="btn btn-outline-dark decrease" type="button" style="font-size: 12px;">-</button>
                  </div>
                  <div id="stockLimitMessage_<%= item.product._id %>" style="color: red; display: none; font-size: smaller;"><small>Yoy can purchase Only three products at this time</small></div>
                  </td>
                  <td class="actions" data-th="">
                    <div class="text-right">
                      <button class="btn btn-white border-secondary bg-white btn-md mb-2 ">
                        <i class="fas fa-sync"></i>
                      </button>
                      <a href="/users/cart-remove/<%= item.product._id %>"><button class="btn btn-white border-secondary bg-white btn-md mb-2 " >
                        <i class="fas fa-trash"></i>
                      </button></a>
                    </div>
                  </td>
                </tr>
                <% total += item.product.price * item.quantity; %>
              <% }); %>
              <tr>
                <td colspan="3" class="text-right">Total Price:</td>
                <td><span id="totalprice">Rs. <%= total %></span></td>
              </tr>
            <% } else { %>
              <tr>
                <td colspan="4">
                  <h1>Cart is Empty</h1>
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
        <div class="float-right text-right">
          
        </div>
      </div>
    </div>
    <div class="row mt-4 d-flex align-items-center">
      <div class="col-sm-6 order-md-2 text-right">
        <a href="/users/checkout" class="btn btn-primary mb-4 btn-lg pl-5 pr-5">Checkout</a>
      </div>
      <div class="col-sm-6 mb-3 mb-m-1 order-md-1 text-md-left">
        <a href="/users/home">
          <i class="fas fa-arrow-left mr-2"></i> Continue Shopping
        </a>
      </div>
    </div>
  </div>
</section>






<script>
  function updateCart(productId, quantity, Price) {
    console.log('Sending request to update cart. ProductId:', productId, 'Quantity:', quantity);

    fetch('/users/updateQuantity', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        productId: productId,
        quantity: quantity,
        totalPrice: Price
      })
    })
    .then(response => response.json())
    .then(response => {
      let totalPrice = 0;
      console.log(response);

      if (response.subtotal && Array.isArray(response.subtotal)) {
        response.subtotal.forEach(subtotalData => {
          const productId = subtotalData.productId;
          const subtotal = subtotalData.subtotal;

          const subtotalElement = document.getElementById(`subtotalId_${productId}`);

          if (subtotalElement) {
            subtotalElement.innerHTML = `Rs. ${subtotal}`;
          }
         totalPrice = response.subtotal.reduce((acc, item) => acc + item.subtotal, 0);
        });

        document.getElementById("totalprice").innerHTML = `RS. ${totalPrice}`;
      } else {
        console.error('Invalid response format: response.subtotals is not an array.');
      }

      if (response.quantity >= 3) {
        document.getElementById(`stockLimitMessage_${response.prodId}`).style.display = 'block';
        return;
      } else {
        document.getElementById(`stockLimitMessage_${response.prodId}`).style.display = 'none';
      }

      console.log(response.prodId);
    })
    .catch(error => {
      console.error('Error updating cart: ', error);
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
  var totalPrice = parseFloat(document.getElementById('totalprice').textContent);

  document.querySelectorAll('.increase').forEach(button => {
    button.addEventListener('click', function () {
      var inputElement = this.closest('tr').querySelector('.quantity-amount');
      var productId = inputElement.dataset.productId;
      var currentQuantity = parseInt(inputElement.value);
      var newQuantity = currentQuantity + 1;
      var priceElement = this.closest('tr').querySelector('[data-th="Price"]');
      var productPrice = parseFloat(priceElement.textContent);

      //Stock limit checking code
      if (currentQuantity >= 3) {
        document.getElementById(`stockLimitMessage_${productId}`).style.display = 'block';
        return; 
      }

      console.log('Increase button clicked. ProductId:', productId, 'New Quantity:', newQuantity, 'New Total Price:', totalPrice + productPrice);
      inputElement.value = newQuantity;
      updateCart(productId, newQuantity, totalPrice + productPrice);
    });
  });

  document.querySelectorAll('.decrease').forEach(button => {
    button.addEventListener('click', function () {
      var inputElement = this.closest('tr').querySelector('.quantity-amount');
      var productId = inputElement.dataset.productId;
      var currentQuantity = parseInt(inputElement.value);

      // Hide stock limit msg
      document.getElementById(`stockLimitMessage_${productId}`).style.display = 'none';

      if (currentQuantity > 1) {
        var newQuantity = currentQuantity - 1;
        var priceElement = this.closest('tr').querySelector('[data-th="Price"]');
        var productPrice = parseFloat(priceElement.textContent);

        console.log('Decrease button clicked. ProductId:', productId, 'New Quantity:', newQuantity, 'New Total Price:', totalPrice - productPrice);
        inputElement.value = newQuantity;
        updateCart(productId, newQuantity, totalPrice - productPrice);
      }
    });
  });
});

</script>
